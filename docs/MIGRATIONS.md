# Database Migrations Guide

## Overview

This project uses [golang-migrate](https://github.com/golang-migrate/migrate) for database migrations and [sqlc](https://sqlc.dev/) for type-safe SQL in Go. This document describes the workflow for creating and managing database migrations.

## Directory Structure

- `internal/db/migrations/`: Contains all migration files
- `db/schema.sql`: Canonical schema definition for sqlc (auto-generated)
- `db/query.sql`: SQL queries for sqlc code generation
- `scripts/generate_schema.sh`: Script to generate schema.sql from migrations
- `scripts/lint_schema.sh`: Script to verify schema.sql is in sync with migrations
- `scripts/new_migration.sh`: Helper for creating new migrations

## Creating a New Migration

1. Use the helper script to create a new migration:

```bash
./scripts/new_migration.sh add_user_preferences
```

2. This will create two files:
   - `internal/db/migrations/XXXXXX_add_user_preferences.up.sql`: For forward migration
   - `internal/db/migrations/XXXXXX_add_user_preferences.down.sql`: For rollback

3. Edit these files to define your schema changes. For example:

```sql
-- up.sql
CREATE TABLE user_preferences (
  user_id TEXT PRIMARY KEY,
  theme TEXT NOT NULL DEFAULT 'light',
  notifications_enabled BOOLEAN NOT NULL DEFAULT 1,
  FOREIGN KEY (user_id) REFERENCES users(id)
);

-- down.sql
DROP TABLE user_preferences;
```

4. Generate the canonical schema:

```bash
task schema:generate
```

5. Verify the schema is in sync:

```bash
task schema:check
```

6. Include both your migration files AND the updated schema.sql in your commit.

## Important Workflow Rules

1. **Never** edit `db/schema.sql` directly - it is auto-generated from migrations
2. **Always** run `task schema:generate` after creating or editing migrations
3. **Always** commit both migrations and the updated schema.sql
4. The CI pipeline will verify the schema is in sync with migrations

## How It Works

- The canonical schema is generated by applying all migrations to an in-memory SQLite database
- sqlc uses this canonical schema to generate type-safe Go code
- At runtime, migrations are applied sequentially to the actual database

## Troubleshooting

If the `task schema:check` fails, it means your `db/schema.sql` is out of sync with your migrations. Run `task schema:generate` to update it.

If you encounter errors applying migrations, check:
1. Migration naming and order (they're applied alphabetically)
2. Syntax issues in your SQL
3. Make sure your migrations pass SQLite constraints
